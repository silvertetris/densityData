package org.example.densitydata.service.townScaleData;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.io.File;

@Service
public class SeoulTownScaleDataExtractionService {
    private Logger logger = LogManager.getLogger(SeoulTownScaleDataExtractionService.class);

    @Autowired
    private RestTemplate restTemplate;

    @Value("${KOSIS_API_TOKEN}")
    private String apiKey;

    public void populationData() {
        String url1 = "https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey=ODdjZDY5MWMyNTI5M2VmMjUzODYxMzhkOWEzZGEzYjU=&itmId=T2+&objL1=11110+1111051500+1111053000+1111054000+1111055000+1111056000+1111057000+1111058000+1111060000+1111061500+1111063000+1111064000+1111065000+1111066000+1111067000+1111068000+1111069000+1111070000+1111071000+11140+1114052000+1114054000+1114055000+1114057000+1114058000+1114059000+1114060500+1114061000+1114061500+1114062000+1114062500+1114063000+1114063500+1114064000+1114064500+1114065000+1114066000+1114066500+1114067000+1114068000+11170+1117051000+1117052000+1117053000+1117055500+1117056000+1117057000+1117058000+1117059000+1117062500+1117063000+1117064000+1117065000+1117066000+1117068500+1117069000+1117070000+11200+1120052000+1120053500+1120054000+1120055000+1120056000+1120057000+1120058000+1120059000+1120061500+1120062000+1120064500+1120065000+1120066000+1120067000+1120069000+1120072000+1120079000+11215+1121571000+1121573000+1121574000+1121575000+1121576000+1121577000+1121578000+1121581000+1121582000+1121583000+1121584000+1121584700+1121585000+1121586000+1121587000+11230+1123051500+1123053300+1123053600+1123054500+1123056000+1123057000+1123060000+1123061000+1123065000+1123066000+1123070500+1123071000+1123072000+1123073000+1123074000+1123075000+11260+1126052000+1126054000+1126055000+1126056500+1126057000+1126057500+1126058000+1126059000+1126060000+1126061000+1126062000+1126063000+1126065500+1126066000+1126068000+1126069000+11290+1129052500+1129055500+1129057500+1129058000+1129059000+1129060000+1129061000+1129062000+1129063000+1129064000+1129065000+1129066000+1129068500+1129070500+1129071500+1129072500+1129076000+1129077000+1129078000+1129081000+11305+1130553400+1130553500+1130554500+1130555500+1130557500+1130559000+1130559500+1130560000+1130560300+1130560600+1130560800+1130561000+1130561500+1130562000+1130562500+1130563000+1130563500+1130564500+1130566000+11320+1132051100+1132051200+1132051300+1132051400+1132051500+1132052100+1132052200+1132066000+1132067000+1132068000+1132068100+1132069000+1132070000+1132071000+11350+1135056000+1135057000+1135058000+1135059500+1135060000+1135061100+1135061200+1135061900+1135062100+1135062400+1135062500+1135063000+1135064000+1135066500+1135067000+1135069500+1135070000+1135071000+1135072000&objL2=0&format=json&jsonVD=Y&prdSe=M&newEstPrdCnt=360&orgId=101&tblId=DT_1B04005N";
        String url2 = "https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey=ODdjZDY5MWMyNTI5M2VmMjUzODYxMzhkOWEzZGEzYjU=&itmId=T2+&objL1=11380+1138051000+1138052000+1138053000+1138055100+1138055200+1138056000+1138057000+1138058000+1138059000+1138060000+1138062500+1138063100+1138063200+1138064000+1138065000+1138069000+11410+1141052000+1141055500+1141056500+1141058500+1141061500+1141062000+1141064000+1141065500+1141066000+1141068500+1141069000+1141070000+1141071000+1141072000+11440+1144055500+1144056500+1144058500+1144059000+1144060000+1144061000+1144063000+1144065500+1144066000+1144068000+1144069000+1144070000+1144071000+1144072000+1144073000+1144074000+11470+1147051000+1147052000+1147053000+1147054000+1147055000+1147056000+1147057000+1147058000+1147059000+1147060000+1147061000+1147061100+1147062000+1147063000+1147064000+1147065000+1147067000+1147068000&objL2=0&format=json&jsonVD=Y&prdSe=M&newEstPrdCnt=360&orgId=101&tblId=DT_1B04005N";
        String url3 = "https://kosis.kr/openapi/Param/statisticsParameterData.do?method=getList&apiKey=ODdjZDY5MWMyNTI5M2VmMjUzODYxMzhkOWEzZGEzYjU=&itmId=T2+&objL1=11500+1150051000+1150052000+1150053000+1150053500+1150054000+1150055000+1150056000+1150057000+1150059000+1150059100+1150059300+1150060300+1150060400+1150060500+1150061100+1150061500+1150062000+1150063000+1150064000+1150064100+11530+1153051000+1153052000+1153053000+1153054000+1153055000+1153056000+1153059500+1153072000+1153073000+1153074000+1153075000+1153076000+1153077000+1153078000+1153079000+1153080000+11545+1154551000+1154561000+1154562000+1154563000+1154564000+1154567000+1154568000+1154569000+1154570000+1154571000+11560+1156051500+1156053500+1156054000+1156055000+1156056000+1156058500+1156060500+1156061000+1156062000+1156063000+1156065000+1156066000+1156067000+1156068000+1156069000+1156070000+1156071000+1156072000+11590+1159051000+1159052000+1159053000+1159054000+1159055000+1159056000+1159060500+1159062000+1159063000+1159064000+1159065000+1159065100+1159066000+1159067000+1159068000+11620+1162052500+1162054500+1162056500+1162057500+1162058500+1162059500+1162060500+1162061500+1162062500+1162063000+1162064500+1162065500+1162066500+1162068500+1162069500+1162071500+1162072500+1162073500+1162074500+1162076500+1162077500+11650+1165051000+1165052000+1165053000+1165053100+1165054000+1165055000+1165056000+1165057000+1165058000+1165058100+1165059000+1165060000+1165061000+1165062000+1165062100+1165065100+1165065200+1165066000+11680+1168051000+1168052100+1168053100+1168054500+1168056500+1168058000+1168059000+1168060000+1168061000+1168063000+1168064000+1168065000+1168065500+1168065600+1168066000+1168067000+1168067500+1168069000+1168070000+1168072000+1168073000+1168074000+1168075000+11710+1171051000+1171052000+1171053100+1171053200+1171054000+1171055000+1171056100+1171056200+1171056600+1171057000+1171058000+1171059000+1171060000+1171061000+1171062000+1171063100+1171063200+1171064100+1171064200+1171064600+1171064700+1171065000+1171067000+1171068000+1171069000+1171071000+1171072000+11740+1174051500+1174052000+1174052500+1174052600+1174053000+1174054000+1174055000+1174056000+1174057000+1174058000+1174059000+1174060000+1174061000+1174062000+1174064000+1174065000+1174066000+1174068500+1174069000+1174070000&objL2=0&format=json&jsonVD=Y&prdSe=M&newEstPrdCnt=360&orgId=101&tblId=DT_1B04005N";

        HttpHeaders headers = new HttpHeaders();
        headers.add("Content-Type", "application/json");
        HttpEntity<String> entity = new HttpEntity<>(headers);

        String responseBody1 = restTemplate.exchange(url1, HttpMethod.GET, entity, String.class).getBody();
        String responseBody2 = restTemplate.exchange(url2, HttpMethod.GET, entity, String.class).getBody();
        String responseBody3 = restTemplate.exchange(url3, HttpMethod.GET, entity, String.class).getBody();
        try {
            ObjectMapper mapper = new ObjectMapper();
            JsonNode json1 = mapper.readTree(responseBody1);
            JsonNode json2 = mapper.readTree(responseBody2);
            JsonNode json3 = mapper.readTree(responseBody3);
            File dir = new File("./PopulationData");
            if (!dir.exists()) dir.mkdirs();
            String fileName1 = "seoul_town_scale_data_1.json";
            String fileName2 = "seoul_town_scale_data_2.json";
            String fileName3 = "seoul_town_scale_data_3.json";
            File file1 = new File(dir, fileName1);
            File file2 = new File(dir, fileName2);
            File file3 = new File(dir, fileName3);
            mapper.writerWithDefaultPrettyPrinter().writeValue(file1, json1);
            mapper.writerWithDefaultPrettyPrinter().writeValue(file2, json2);
            mapper.writerWithDefaultPrettyPrinter().writeValue(file3, json3);
            logger.info("[SeoulTownScaleDataExtractionService] 파일 저장 성공");
        } catch (Exception e) {
            logger.error("Error in parsing json response of url");
        }

    }
}
